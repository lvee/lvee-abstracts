\documentclass[10pt, a5paper]{article}
\input{preamble.tex}
\title{LXD\footnote{\url{denis_pynkin@epam.com}, \url{http://lvee.org/ru/abstracts/237}}}
\author{Denis Pynkin, Minsk, Belarus}
\begin{document}

\maketitle

\begin{abstract}

\end{abstract}

\subsection*{Введение}

Проект Linux Containers (\url{https://linuxcontainers.org}) уже долгое время занимается развитием набора утилит LXC, позволяющего управлять 
локальными контейнерами. При этом, основное отличие LXC от других подобных 
систем, это создание и управление контейнерами уровня операционной системы.

В связи со взрывным ростом использования контейнеров в облачных средах,
активно развиваются и системы управления контейнерами, такие как 
{\tt Docker}, поэтому логичным шагом для проекта Linux Containers было
создание своей системы управления LXD, которая позволяет унифицировать 
управление множеством контейнеров LXC на разных хостах.

В докладе рассказывается о настройке и использовании LXD, основываясь на опыте
пакетирования проекта для ОС ALTLinux и портирования среды разработки 
коммерческого проекта в контейнер LXC.

\subsection*{Состав проекта}

Проект состоит из 4 основных частей:
\begin{itemize}
    \item {LXC} "--- ядро системы, обеспечивающее низкоуровневое управление 
    контейнерами;
    \item {LXD} "--- <<высокоуровневая>> часть системы управления, предоставляющая
    единообразное API управления, а также утилиты командной строки;
    \item {\tt CGManager} "--- демон для управления контролем групп, позволяющий 
    создавать и использовать непривилегированные контейнеры;
    \item {\tt lxcfs} "--- файловая система на базе FUSE, <<скрывающая>> реальные 
    подсистемы {\tt procfs}, {\tt sysfs} и {\tt cgroupfs}, изолируя доступ к ним 
    от программ,  работающих внутри контейнеров.
\end{itemize}

\subsection*{Установка LXD}
Установка LXD:
\begin{verbatim}
apt-get install lxd
\end{verbatim}

В результате будут установлены 2 программы для управления LXC-контейнерами, написанные на 
языке Go "--- {\tt lxd} и {\tt lxc}, демон и клиент соответственно.

Вместе с LXC будут устанолены все необходимые подпроекты:
\begin{itemize}
    \item cgmanager
    \item lxcfs
    \item LXC
\end{itemize}

Требования:
\begin{itemize}
    \item пакет {\tt shadow-submap} "--- {\tt subuid} и {\tt subgid} для 
          корректной работы непривилегированных контейнеров;
    \item {\tt criu} "--- библиотека и утилиты для сохранения и
        восстановления контейнера, позволяющая, в том числе, организовать
        <<живую>> миграцию между хостами.
\end{itemize}

Для понижения привелегий пользователя {\tt root} используется
механизм ядра {\tt Linux user namespaces}, для чего настраивается
список подчиненных идентификаторов пользователя и групп.
Эти идентификаторы используются чтобы установить соответствие пользователя
внутри контейнера с реальным пользователем.

Так, чтобы пользователь {\tt root} внутри контейнера имел реальный UID,
отличный от <<0>>, необходимо добавить соответствие 
подчиненных идентификаторов пользователя и групп:

\begin{frame}{Непривилигированный root}

\begin{verbatim}
usermod -v 100000-165535 -w 100000-165535 root
\end{verbatim}

Таким образом <<{\tt root}>> внутри контейнера будет иметь UID и GID равными <<0>>,
но из-вне контейнера все процессы такого <<администратора>> будут принадлежать
пользователю и группе из заданного диапазона.
\end{frame}

Такое соответствие эффективно изолирует пользователя контейнера от возможностей,
предоставляемых хостовой операционной системой пользователю {\tt root}, обеспечивая
повышенную защищенность хостовой ОС от контейнера.

\subsection*{Дисковое пространство}

{LXD} поддерживает различные хранилища для контейнеров, начиная от {\tt LVM} 
и заканчивая файловыми системами {\tt btrfs} и {\tt ZFS}, которые позволяют 
значительно ускорить создание новых контейнеров, а также сохранение и восстановление 
снэпшотов систем.

Хотя использование "классических" файловых систем допускается, но и эффективность работы со 
множеством однотипных контейнеров тоже падает. Для таких случаев предлагается воспользоваться
скриптом {\tt lxd-setup-lvm-storage} для создания файла-образа для организации дискового
хранилища LVM.

\subsection*{Сеть}

Поскольку {LXD} является, по сути, управляющей системой контейнерами LXC,
то и сеть можно организовать по-разному, начиная от выделения контейнеру 
физического интерфейса и заканчивая рекомендуемым режимом с организацией
виртуального моста (bridge).

Такой мост можно как создать и сконфигурировать самостоятельно, так и положиться на 
встроенные демон {LXD} "--- в обоих случаях достаточно добавить несколько строчек в
системный файл конфигурации.

\subsection*{Пользовательская конфигурация}
Локальная конфигурация пользователя находится в:
\begin{verbatim}
~/.config/lxc
\end{verbatim}
и включает в себя ключ и сертификат пользователя,
а также настройки подключения к удаленным серверам LXD.

\subsection*{Системные образы}

Одной из основных проблем, которые решает {LXD} является 
централизованное управление образами контейнеров.

Для старых версий {LXC} созданием контейнера по сути занимались 
отдельные скрипты-темплейты, которые не отличаются однообразием и 
пишутся отдельно для каждого дистрибутива.

При проектировании {LXD} было решено уйти от такой практики и 
использовать хранилище готовых образов (по сути архив rootfs), 
подготовить которые можно даже вручную.

Такой образ представляет собой готовую к разворачиванию систему,
а также описание как самого образа системы, так и действий,
которые необходимо произвести при создании или запуске 
контейнера "--- модифицировать файл {\tt /etc/hosts}, например.

Типы образов:
\begin{itemize}
    \item {\tt unified} "--- все в одном, хорошо подходит 
        для распространения готового продукта;
    \item {\tt split} "--- раздельно metadata и rootfs, что очень 
        удобно при разработке.
\end{itemize}

\subsection*{Конфигурация контейнера}

Каждый контейнер использует свою собственную конфигурацию с описанием
{LXC}-контейнера: имя, описание, какие устройства необходимо подключить и
какие привилегии есть у контейнера. Кроме того можно использовать и низкоуровневое
описание lxc-контейнеров.

Для однотипных контейнеров можно использовать так называемые профили, которые можно
указать при создании контейнера, либо добавить позднее, с помощью команды 
{\tt lxc profile apply \ldots}. Такой профиль является аналогом <<include>> для описания 
контейнера, так что все элементы описанные в профиле включаются в описание 
самого контейнера, позволяя хранить общие настройки в одном месте.

Неполный пример профиля, выполняющий специфическую настройку для одного проекта, 
в котором указано, что:
\begin{itemize}
    \item контейнер будет привилигированным
    \item с полным доступом к {\tt procfs}, {\tt cgroupfs} 
        и частично ограниченным на запись к {\tt sysfs}
    \item без автоматически добавляемой системы {\tt devfs}
    \item разрешением на загрузку модулей ядра {\tt loop} и {\tt tun}
    \item одним сетевым интерфейсом, подключенным к локальному мосту
    \item пробрасыванием директории {\tt /lib/modules} в контейнер 
        в R/O режиме (для загрузки модулей от текущего ядра)
    \item вместо {\tt init} при запуске будет использоваться свой 
        собственный shell-скрипт {\tt /sbin/lxcinit}
\end{itemize}

\begin{verbatim}
name: customername
config:
  linux.kernel_modules: loop,tun
  raw.lxc: |
    lxc.init_cmd = /bin/bash /sbin/lxcinit
    lxc.mount.auto = proc:rw sys:mixed cgroup:rw
    lxc.autodev = 0
    # tun
    lxc.cgroup.devices.allow = c 10:200 rwm
    # loop for images creation
    lxc.cgroup.devices.allow = b 7:* rwm
  security.nesting: "true"
  security.privileged: "true"
description: ""
devices:
  eth0:
  name: eth0
  nictype: bridged
  parent: lxcbr0
  type: nic
modules:
  path: /lib/modules
  readonly: "true"
  source: /lib/modules
  type: disk
\end{verbatim}

\subsection*{Пример создания контейнера}

Создание профиля из файла описания, приведенного выше:

\begin{verbatim}
lxc profile create customername
cat profile.yaml | lxd profile edit customername
\end{verbatim}

Пример минимального файла-описания {\tt metadata.yaml}:
\begin{verbatim}
architecture: "x86_64"
creation_date: 1470920887
properties:
  architecture: "x86_64"
  description: "Custom development image"
  os: "fedora"
  release: "1.2.3"
templates:
\end{verbatim}

Создание образа для тестирования в формате {\tt split}:
\begin{verbatim}
tar -czf custom.tar.gz metadata.yaml
tar -C <путь к корню> -czf rootfs.tar.gz .
\end{verbatim}

Импортирование образа в {LXD} с присвоением ему уникального имени <<{\tt imagename}>>:
\begin{verbatim}
lxc image import custom.tar.gz rootfs.tar.gz --alias imagename
\end{verbatim}

Создание и запуск нового контейнера <<{\tt name}>>,  созданного из 
образа <<{\tt imagename}>> с конфигурацией, указанной в профиле <<{\tt customername}>>:
\begin{verbatim}
lxc launch imagename name -p customername
\end{verbatim}

\end{document}
