\documentclass[10pt, a5paper]{article}
\input{preamble.tex}
\begin{document}
\title{Реализация UEFI SecureBoot в ALT Linux}
\author{Михаил Шигорин, Киев, Украина}
\maketitle
\begin{abstract}
There are many misunderstandings and myths related to UEFI in general and SecureBoot extension in particular; I've implemented both within ALT Linux distribution and would like to help sort things out.
\end{abstract}
\subsection*{Вводная}

Следует оговориться, что задокументированная реализация построена поверх предшествовавшей работы по поддержке загрузки в режиме UEFI, о чём было бы полезно написать отдельное HOWTO к тому моменту, когда мы этим занялись (конец 2012 года).  Поскольку на данный момент основные дистрибутивы скорее умеют такую загрузку, было решено ограничиться пользовательской страничкой на вики и документированием средств сборки.

Ситуация с SecureBoot отличалась: по состоянию на 2013 год загружаться без отключения этой «ручки» и лишних проблем умели только Fedora, openSUSE и Ubuntu, причём сведения о реализации оказывались либо устаревшими, либо лоскутными, либо вместе.

Проблему можно охарактеризовать в нескольких частях, некоторые из которых являются (по крайней мере пока) одноразовыми, а другие "--- повторяющимися либо имеющими шанс свалиться на голову.

\subsection*{Одноразовая морока}

Как и описывал Matthew Garrett, для авторизации на sysdev.mi\-cro\-soft.com пришлось обеспечить наличие IE/Windows, сертификата Symantec и логина live.com.

Сертификат Verisign/Symantec понадобится единственный раз, чтобы аутентифицировать компанию при регистрации на портале UEFI CA, а затем каждый раз, когда вы готовитесь загрузить очередной объект на рассмотрение и подпись. Это сертификат Au\-then\-ti\-code class 3; его можно получить с одноразовой скидкой через Windows Dev Center. Для получения сертификата понадобится IE7+ с нестандартными настройками ActiveX "--- чтобы сначала его сгенерировать и импортировать, а затем экспортировать в файл.

Та же Windows-система (реальная или виртуальная) пригодится для заведения акаунта на  sysdev.mi\-cro\-soft.com. Предлагаемые шаги:

\begin{enumerate}
  \item завести акаунт live.com (sysdev.microsoft.com требует его для работы);
  \item привязать/аутентифицировать компанию к этому акаунту (однократная процедура, заключается в подписывании тестового бинарника сертификатом Symantec/Verisign);
  \item прочитать и принять лицензионные соглашения Microsoft.
\end{enumerate}

Вам понадобится создать базу данных NSS с импортированными в нее сертификатами Symantec, скачать winqualexe.zip с сайта sysdev.microsoft.com, распаковать и подписать его (используя pesign), а затем закачать подписанный winqual.exe обратно. На момент осени 2013 г. требуется подписать лицензионные соглашения «Windows Logo Program Testing Agreement V3» и «UEFI Firmware Agreement».

\subsection*{Многократная морока}

Получение подписанного бинарника shim "--- последующая многократная процедура, которая выполняется каждый раз, когда вы собираете новую версию оного в пакет для выпуска. В процессе будет задействован все тот же Windows-хост или виртуалка с установленным Silverlight, подготовленный shim.efi с публичной частью вашего  cacert, сертификат Symantec (чтобы подписать заявку), а также акаунт sysdev с правами подписи UEFI.  Процедура занимает от нескольких дней до нескольких недель.

Процесс включает следующие шаги:

\begin{enumerate}
  \item подготовка shim.efi;
  \item заливка shim.cab на sysdev.microsoft.com;
  \item отправка запроса на sysdev@microsoft.com;
  \item ожидание и периодическая проверка входящих и спам-бокса вашего почтового акаунта;
  \item скачивание подписанного бинарника, если/когда процесс наконец будет завершен.
\end{enumerate}

По большому счету, есть два варианта EFI shim: старше версии 0.5 либо новее (сама версия 0.5 поломана). Начиная с версии 0.5, реализованы дополнительные ограничения по вторичному загрузчику, что потребует подписывать еще и образы ядра. Версия 0.4 лишена этого функционала, но нет гарантии, что вам удастся ее подписать (как это удалось сделать нам).

При подаче заявки с shim.cab вы получите номер заявки "--- submission ID, который потом будет использоваться в переписке с sysdev@microsoft.com для идентификации вашей заявки. Переписка может включать типовой вопросник от sysdev@microsoft.com на предмет дополнительных подробностей о вашем shim. По-видимому, в sysdev проверяют очередь заявок раз или два в неделю. Чтобы ускорить процедуру, можно заранее выслать ответы на ссылкой на полученный submission ID в теме письма.

\subsection*{Собирая все вместе}

После получения подписанного бинарника shim понадобится аппаратный или виртуальный стенд со включенным SecureBoot, поддержка UEFI boot/install, а также терпение для внесения доработок в уже работающие части.
Вы должны убедиться в наличии верифицированной загрузочной цепочки при включенном SecureBoot как для установочного/загрузочного образа, так и для установленной ОС:

\begin{enumerate}
  \item bootx64.efi или shim.efi (shim);
  \item grubx64.efi (первичный бутменеджер или загрузчик);
  \item vmlinuz (ядро) либо вторичный загрузчик;
\end{enumerate}

цепочка может варьироваться после shim, но основные принципы сохраняются:

\begin{enumerate}
  \item shim верифицируется ключем, который предоставляется для firmware с помощью KEK/DB, а затем верифицирует бинарник загрузчика с помощью встроенного сертификата, MOK или firmware;
  \item последующие загрузчики могут обмениваться информацией с shim чтобы использовать информацию о вашем сертификате, встроенном в него, и MOK, добавленных пользователем конкретной машины.
\end{enumerate}

\newpage
\subsection*{ALT way}

Ваша  реализация может сильно отличаться; ALT Linux сейчас использует следующую:

shim $\rightarrow$ refind $\rightarrow$ elilo $\rightarrow$ vmlinuz для install/live/rescue media 

shim $\rightarrow$ grub2 $\rightarrow$ vmlinuz для установленной системы

Мы используем refind в качестве бут-менеджера, поскольку некоторые реализации UEFI поставляются с кривыми реализациями выбора цели загрузки или не имеют таковой вовсе; elilo работает в качестве фильтра, позволяющего загрузить ядро Linux "--- нам это необходимо, т.\,к. мы хотим дать пользователям возможность загрузки неподписанных ядер и при этом не оставлять дыру, позволяющую загрузить что попало.

\end{document}
