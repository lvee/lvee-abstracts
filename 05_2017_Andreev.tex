\documentclass[10pt, a5paper]{article}
\input{preamble.tex}
\switchlang{ru}
\begin{document}
\title{О Модели Данных SQL/JSON}
\author{Андреев Юрий, Санкт-Петербург, РФ\footnote{\url{andreev.yurij@gmail.com} \url{http://lvee.org/ru/abstracts/247}}}
\maketitle
\begin{abstract}
An SQL/JSON model is a part of SQL 2016 Standard\cite{AY1} which describes a JSON data model for SQL.
It describes a \textit{jsonpath} data type as a path language and nine functions to deal with JSON data.
A new type of queries will be shown on a special branch of PostgreSQL.
\end{abstract}

\subsection*{Предисловие}
В новою редакцию стандарта SQL\cite{AY1} была включена SQL/JSON модель.
Это означает, что стандарт теперь предполагает работу со слабо-структурированными
данными в JSON формате\cite{AY2}. СУБД Postgres имеет долгую историю поддержки такого типа данных
и теперь идет работа по поддержке новых возможностей стандарта.
Далее мы покажем, какие преимущества дает способ хранения в JSON формате и как 
предполагается делать запросы к таким данным.

\subsection*{Слабо-структурированные данные}
Однажды Землю Винни-Пуха посетил Слон
\footnote{Слон --- это символ PostgreSQL}.
Он вышел на прогулку в прошлую среду
\footnote{на самом деле, еще не вышел. Далее используется разрабатываемая sqljson ветка PostgreSQL.}
и еще не бывал в этих местах.
Ему стало очень интересно узнать, кто здесь живет.
Сначала он навестил Кролика,
\begin{verbatim}
INSERT INTO elephant (name) VALUES ('Кроличья нора'); 
\end{verbatim}
Слон запоминает все в таблицу 
\texttt{elephant}\footnote{названия таблиц и колонок можно также писать и по-русски},
где каждая запись состоит из двух полей: 
имени в обычном строковом представлении (\texttt{name})
и деталей в формате JSON (\texttt{details})
\footnote{на текущий момент, запросы нового типа работают с  данными только в формате JSONB (более строгой форме JSON)}.
Слон узнал \texttt{details}: 
\begin{verbatim}
{
    "жители":"Кролик",
    "проход":"очень узкий",
    "мёд":"ещё немного"
}
\end{verbatim}
Потом он обошел вокруг Дуба (\texttt{name = "Высокий-превысокий Дуб"}), \texttt{details}:
\begin{verbatim}
{
    "жители":"Пчёлы",
    "высота":"так высоко",
    "мёд":"неправильный"
}
\end{verbatim}
Наконец, Cлон зашел к Пяточку (\texttt{name = "Домик Пяточка"}):
\begin{verbatim}
{
    "жители":"Пяточёк",
    "шарики":["синий", "зелёный"]
}
\end{verbatim}
Пяточек сказал, что у него есть друг, с которым Слон обязательно должен познакомиться.
Настала медовая пора и было жарко.
Переходя по мосту реку, он опустил хобот и немного расширился от выпитой воды. 
Слоны вообще хорошо расширяются.
Теперь Слон был готов ко встрече с Винни-Пухом.

\subsection*{Модель SQL/JSON}
Но как же Винни-Пух будет общаться со Слоном?
Всем известно, что слоны разговаривают на SQL. 
Наш же успел понабраться новомодных словечек, и начинает использовать SQL/JSON.
Для запросов в стандарте описаны новые функции, с префиксом \texttt{JSON\_},
а также язык \textit{jsonpath} для навигации по JSON 
(частичный аналог XPath для XML; см. также описание в \cite{AY3}),
выражения на котором передается во втором аргументе. 
Поможем Винни-Пуху. Ему интересны медовые места, для этого он должен спросить Слона:
\begin{verbatim}
SELECT name 
FROM elephant 
WHERE JSON_EXISTS(details,'$.мёд')
------------------------
 Кроличья нора
 Высокий-превысокий Дуб
\end{verbatim}
А насколько Дуб высокий?
\begin{verbatim}
SELECT JSON_VALUE(details, '$.высота') 
FROM elephant 
WHERE name='Высокий-превысокий Дуб';
--------------
 "так высоко"
\end{verbatim}
Чтобы на него подняться, нужны шарики. 
Они есть у Пяточка, это также легко узнать. А сколько же их? 
\begin{verbatim}
SELECT JSON_QUERY(details, '$.шарики.size()') 
FROM elephant 
WHERE name = 'Домик Пяточка';
----------
 2
\end{verbatim}
Есть ли синий? t(True)/f(False)
\begin{verbatim}
SELECT 
    JSON_EXISTS(details, '$.шарики[*] ? (@ == "синий")') 
FROM elephant WHERE name = 'Домик Пяточка';
----------
 t
\end{verbatim}

Пока Винни-Пух летает за медом, можно заметить, что
преимущество JSON/SQL модели, помимо прочего, заключается в том, что Винни-Пух
может придумать множество других запросов, 
а Слон, гуляя, может произвольно дополнять свои знания:
выделить улей, как отдельный объект в составе Дуба; 
добавить содержание надписей на вывесках у домиков, если таковые имеются.
При этом данные будут храниться компактно, и не надо будет перестраивать основную таблицу, что бывает затратно.

Тем  временем у Винни-Пуха появились новые запросы, он собирается в гости к Кролику, чтобы немного подкрепиться.  
Что об этом подумает сам Кролик, мы не узнаем, а вот о чем и как думает Слон мы можем всегда поинтересоваться,
так как Слон --- это open source.

\begin{thebibliography}{9}
\bibitem{AY1} Стандарт SQL, ISO/IEC 9075-2:2016, \url{https://www.iso.org/standard/63556.html}
\bibitem{AY2} JSON формат, RFC 7159, \url{https://www.rfc-editor.org/info/rfc7159}, 
\bibitem{AY3} jsonpath, \url{http://goessner.net/articles/JsonPath/}
\end{thebibliography}

\end{document}
