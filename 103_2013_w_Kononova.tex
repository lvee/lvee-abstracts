\documentclass[10pt, a5paper]{article}
\input{preamble.tex}

\begin{document}

\title{Преобразование документов \LaTeX{} в~формат Word/OpenOffice.org с~использованием Hevea}%\footnote{Текст данных и последующих тезисов, кроме специально оговоренных случаев, доступен под лицензией Creative Commons Attribution-ShareAlike 3.0}

\author{Александра Кононова, Алексей Городилов\footnote{Москва, Зеленоград, РФ}}
\maketitle

\begin{abstract}
\LaTeX $\to$ OpenDocument (ODF) or .doc conversion is a common problem. 
There are tools for such conversion, but the resulting document requires 
substantial manual adjustment. This article proposes set of scripts and 
macroses for automatisation of tedious work, that is needed to convert 
\LaTeX $\to$ HTML and then $\to$ ODF or .doc  using Hevea and subsequent 
adjustment.
\end{abstract}

Издательская система \LaTeX{} весьма удобна для подготовки научных статей и~достаточно популярна в~настоящее время.
Однако редакции многих журналов требуют представлять статьи в~формате «Word for Windows»,
поэтому часто
возникает необходимость иметь один и тот же документ в~разных форматах.
Предлагается автоматизированный инструмент для быстрой конвертации формата \LaTeX $\to$ ODF (\url{git://github.com/illinc/h2o.git}).

В~\cite{h2o:virens:latex-word-openoffice} проведён обзор существующих средств конвертации.
В~этой статье рассматривается использование транслятора Hevea~\cite{h2o:hevea.inria.fr}, редактора sed и~макросов OpenOffice Basic для преобразования \LaTeX $\to$ HTML $\to$ ODF, а~также создание документов, компилирующихся как в~формат PDF, так и~(через HTML) в~формат ODF.
Несмотря на множество недостатков связки Hevea + sed + OpenOffice Basic, с~её помощью нам удалось реализовать комплекс, требующий минимальной ручной доводки полученного документа.

Комплекс разбит на три компонента:
\begin{enumerate}
\item Заголовочный файл \verb!h2o.tex!, содержащий комплекс макросов, используемых в~коде \LaTeX.
\item Скрипт \verb!mkh2o!, содержащий команды трансляции \LaTeX $\to$ HTML, а~также исправление «на лету» промежуточных файлов и~результирующего HTML.
\item Расширение OpenOffice \verb!h2o.oxt!, написанное на OpenOffice Basic и~содержащее макросы для окончательной доводки документа.
\end{enumerate}


\subsection*{Подготовка исходного кода \LaTeX}

Для того, чтобы документ мог быть собран как компиляторами latex, pdflatex, так и~компилятором Hevea, в~его преамбулу и~исходный код необходимо внести некоторые дополнения.

Различный код для различных компиляторов в~такой связке может быть реализован командами условной компиляции Hevea.

Блок, окружённый комментариями \verb!%BEGIN LATEX!...\verb!%END LATEX!, игнорируется Hevea.
Строка комментария, начинающаяся с~\verb!%HEVEA!, выполняется Hevea, но воспринимается любым другим компилятором как комментарий.

Используя такое свойство этих комментариев, можно создать
файл, который можно будет обрабатывать любым из вышеперечисленных компиляторов.
% требуется определить некоторый набор команд.
Все необходимые для этого команды в~кодировке utf8, кроме непосредственно выбора кодировки, помещаются для удобства использования в~файл \verb!h2o.tex!. Тогда этот заголовок можно будет просто вставлять в любой обрабатываемый файл с помощью команды \verb!\input{h2o}!.

\subsubsection*{Кодировка}

Популярная кодировка utf8x не поддерживается Hevea, поэтому для компиляции в~HTML необходимо указать кодировку utf8:
\begin{verbatim}
%BEGIN LATEX
\usepackage[utf8x]{inputenc}
%END LATEX
%HEVEA \usepackage[utf8]{inputenc}
\end{verbatim}

Однобайтовые кодировки воспринимаются компилятором Hevea нормально, но символы, отсутствующие в~таблице кодировки (например, греческие буквы из формул), выглядят неадекватно и~должны преобразовываться в~картинки.

% \subsubsection*{Пакеты}
% 
% Hevea не поддерживает всех возможностей таких популярных пакетов, как \verb!babel!, \verb!caption!, \verb!enumitem!, \verb!tabularx!.
% Однако часть их возможностей может быть реализована макросами вручную.
% 
% Так, русификация заголовков и~подписей может быть выполнена следующим образом:
% \begin{verbatim}
% \renewcommand{\figurename}{Рис.}
% \renewcommand{\tablename}{Таблица }
% \renewcommand{\chaptername}{Глава}
% \renewcommand{\appendixname}{Приложение}
% \end{verbatim}

\subsubsection*{Рисунки и~формулы}
Рисунки результирующего HTML-документа генерируются из страниц создаваемого Hevea файла \verb!<имя документа>.image.tex!.

Рисунки, включаемые командой \verb!\includegraphics!, помещаются в~этот файл автоматически (с~растеризацией векторных рисунков и~сменой разрешения растровых).

Рисунки, выполненные в~системе TikZ/PGF, формулы, которые должны быть преобразованы в~рисунки, и~т.\,п. необходимо поместить в~окружение \verb!toimage!. Для перехода на следующую страницу используется команда \verb!\imageflush!.

Выключные пронумерованные формулы нежелательно помещать в~окружение \verb!toimage! целиком, так как при этом сбивается нумерация и~невозможны ссылки на данную формулу.
Решением может быть помещение внутрь окружения~\verb!equation! окружения, определённого в~файле \verb!h2o.tex! следующим образом:
\begin{verbatim}
\newenvironment{htooeqtoimage}{%
%HEVEA \begin{toimage}\begin{equation*}
}{%
%HEVEA \end{equation*}\end{toimage}\imageflush
}
\end{verbatim}%
не включая в~него метку формулы, т.\,е.:
\begin{verbatim}
\begin{equation}
\label{eq:<метка формулы>}
\begin{htooeqtoimage}
<формула>
\end{htooeqtoimage}
\end{equation}
\end{verbatim}

% \subsubsection*{Действия пользователя}
% 
% Выбор кодировки, подключение пакета \texttt{h2o}


\subsection*{Сборка}
Команда \verb!hevea <имя документа>! формирует HTML-файл, файл рисунков \texttt{<имя документа>.image.tex} и~вспомогательные файлы. 

Файлы библиографии %в~соответствии с~ГОСТ 
формируются утилитой \verb!bibtex!, но для использования их компилятором Hevea они дорабатываются редактором \texttt{sed}.

После окончательного формирования HTML-файла многократным запуском \texttt{hevea} происходит корректировка лигатур с~помощью \texttt{sed}
(всё это выполняет написанный нами скрипт сборки \texttt{mkh2o}, вмешательства пользователя не требуется).

\subsubsection*{Рисунки}
Рисунки результирующего HTML-документа генерируются утилитой \texttt{imagen} из страниц создаваемого Hevea файла рисунков \texttt{<имя документа>.image.tex.}
% При запуске \verb!imagen! можно указать формат рисунков, формат файла рисунков, папку с~рисунками и~масштаб.
% \begin{verbatim}
% imagen -png -pdf  -todir $IMGDIR ${DOCNAME}
% \end{verbatim}

Некоторые команды преамбулы не помещаются в~файл \texttt{<имя документа>.image.tex} автоматически, поэтому перед запуском  \texttt{imagen} преамбула дополняется с~помощью \texttt{sed, echo} и~других стандартных утилит.


\subsection*{Обработка полученного текста в~OpenOffice}

Для преобразования полученного HTML-файла в~формат~ODF нами написано расширение \texttt{h2o.oxt},
содержащее код для внедрения в~текст и~масштабирования рисунков, сносок, размещения текста на странице и~других элементов форматирования, отсутствующих в~HTML.

\subsection*{Последовательность обработки}

\begin{enumerate}
\item Преамбула исходного документа \LaTeX{} дополняется заголовком \texttt{h2o} и~выбором кодировки utf8 для Hevea,
в~тело документа внедряются окружения \texttt{toimage} и~\texttt{htooeqtoimage} и, при необходимости, команды двойной компиляции.
В~каталог документа помещаются файлы  \texttt{h2o.tex} и~\texttt{mkh2o}.

\item Для сборки документа запускается скрипт \texttt{mkh2o}.

\item Текст полученного HTML-файла переносится в~ODF и~запускается головной макрос расширения \texttt{h2o.oxt} "--- \texttt{h2oMain}.
\end{enumerate}



% \bibliography{h2o}
% \bibliographystyle{gost705}


\begin{thebibliography}{9}
\bibitem{h2o:virens:latex-word-openoffice}
{Конник~М.} Перевод документов из LaTeX в Word / OpenOffice.
  \url{http://mydebianblog.blogspot.ru/2007/01/latex-word-openoffice.html}.
 2007.

\bibitem{h2o:hevea.inria.fr}
The HEVEA Home page.
 \url{http://hevea.inria.fr/}.
 2013.

\end{thebibliography}


\end{document}




