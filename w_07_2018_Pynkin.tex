\documentclass[10pt, a5paper]{article}
\input{preamble.tex}
\switchlang{ru}
\begin{document}
\title{Debos~--- еще одна утилита для создания ОС
\footnote{\url{d4s@t-linux.by}, \url{https://lvee.org/en/abstracts/263}}}
\author{Denis Pynkin, Minsk, Belarus}
\maketitle
\begin{abstract}
Debos is a tool to make creation of various debian based os <<images>> simpler. While most other tools focus on specific use-case, debos is more meant as a toolchain to make comon actions trivial while providing enough rope to do whatever tweaking that might be required behind the scene.
\end{abstract}
Утилита Debos (\url{https://github.com/go-debos/debos}) создана \\Sjoerd Simons (\url{https://github.com/sjoerdsimons}) в качестве альтернативы существующим системам подготовки образов дисков на базе дистрибутива Debian, с прицелом на встраиваемые системы. Основная задача, которую решает Debos~--- максимально упростить пользователю описание для создания образов систем, готовых к <<заливке>> на целевое устройство.

Для реализации основной задачи используются несколько принципов, заложенных в архитектуру проекта:

\begin{itemize}
  \item вся информация о сборке должна находится в конфигурационном файле или <<рецепте>>(recipe) проекта;
  \item строго последовательное выполнение действий при создании образа;
  \item для каждого отдельного действия (action) создается свой модуль;
  \item действия должны быть самодостаточными и, в идеале, не связанными друг с другом;
  \item каждое действие должно быть простым~--- для сложных задач декларируется использование пользовательких скриптов и/или внешних программ.
\end{itemize}

Одна из стандартных проблем, которая возникает при сборке образа~--- это необходимость использования повышенных привилегий для некоторых шагов, таких как установка пакетов. Разными утилитами и дистрибутивами эта задача решается по-разному. Для Debos используется библиотека fakemachine (\url{https://github.com/go-debos/fakemachine}), также написанная Sjoerd Simons. Данная библиотека использует виртуальную машину Qemu, позволяя работать с <<повышенными>> привилегиями, в текущей системе. Кроме того, такой подход позволяет без дополнительных затрат организовать сборку образа под любую архитектуру, поддерживаемую в Qemu.

В задачу утилиты не входит создание повторяемого сборочного окружения. Подразумевается, что для каждого проекта оно индивидуально и должно создаваться другими средствами, позволяющими создавать воспроизводимое окружение для запуска~--- Docker, к примеру.

\section*{Синтаксис для recipe}

Конфигурационный файл для создания образа представляет собой файл, описывающий пошаговое выполнение действий, в формате YAML. Для расширения возможностей, при описании конфигурации используется текстовый шаблонизатор (\url{https://golang.org/pkg/text/template}).

Рецепт, условно, можно разделить на 2 части: \textit{заголовок} и \textit{список шагов}.
Для комментирования используется символ <<\#>>. Пример рецепта:

\begin{verbatim}
# Declare variable 'Var'
{{- $Var := "Value" -}}

# Header
architecture: arm64

# Actions are executed in listed order
actions:
  - action: ActionName1
    property1: true

  - action: ActionName2
    # Use value of variable 'Var' defined above
    property2: {{$Var}}
\end{verbatim}
На данный момент поддерживаются следующие базовые действия, которые можно использовать для создания образа системы:
\begin{itemize}
  \item apt~--- установка пакетов в целевое окружение с помощью apt;
  \item debootstrap~--- создание базового окружения с помощью утилиты debootstrap;
  \item download~--- скачивание файла и распаковка, если это необходимо;
  \item filesystem-deploy~--- <<перенос>> подготовленного окружения на образ диска;
  \item image-partition~--- создание файла-образа диска, разметка и создание разделов;
  \item ostree-commit~--- фиксирует ревизию (<<коммитит>>) в репозиторий в формате ostree;
  \item ostree-deploy~--- использует версию из репозитория в формате ostree для подготовки целевого окружения;
  \item overlay~--- позволяет копировать файлы и директории со сборочной системы в целевое окружение;
  \item pack~--- создает архив с целевым окружением, как правило для использования в других сценариях или с помощью <<chroot>> либо аналогов;
  \item raw~--- запись файла напрямую в образ диска или раздела по указанному смещению~--- чаще всего используется для загрузчиков;
  \item run~--- запуск пользовательского скрипта или команды. Можно запускать как в сборочном, так и в целевом окружении;
  \item unpack~--- распаковать архив в целевом окружении.
\end{itemize}
Постоянно обновляемая документация по существующим <<действиям>> (actions) доступна по адресу \url{https://godoc.org/github.com/go-debos/debos/actions}, а пример для создания загружаемого образа, пока что только для Raspberry Pi 3~--- \url{https://github.com/go-debos/debos-recipes}.

\section*{Заключение}

На момент подготовки статьи Debos уже используется в проекте Apertis (\url{https://apertis.org}) при подготовке загружаемых образов дисков, как <<классических>>, так и ostree-based (\url{https://ostree.readthedocs.io}), в том числе и для контейнеров LXC. По мере расширения использования и вовлечения в проект новых людей, находятся и <<латаются>> ошибки, а также появляются новые идеи для новых действий (actions).

\end{document}
